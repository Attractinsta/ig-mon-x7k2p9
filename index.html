<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="mobile-web-app-capable" content="yes" />
<title>Instagram 一括モニター ×18</title>
<style>
  :root{
    --frame-w: 300px;
    --frame-h: 500px;
    --scale: 0.50;
    --cols: 8;
    --gap: 8px;
  }
  *{ box-sizing:border-box; margin:0; padding:0; }
  body{
    margin:0; background:#fafafa;
    font-family:"Noto Sans JP",-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;
    -webkit-font-smoothing:antialiased;
    overflow-x:hidden;
  }
  header{
    position:sticky; top:0; z-index:2;
    background:#ffffffee; backdrop-filter:blur(6px);
    border-bottom:1px solid #ddd; 
    padding:6px 8px;
  }
  .header-main{
    display:flex; justify-content:space-between; align-items:center;
    margin-bottom:6px;
  }
  .title{ 
    font-size:14px; font-weight:600;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .menu-toggle{
    background:#f0f0f0; border:1px solid #ccc;
    padding:4px 10px; border-radius:4px;
    font-size:12px; cursor:pointer;
  }
  .controls{ 
    display:none;
    gap:8px; flex-wrap:wrap; 
    align-items:center; font-size:12px;
    padding-top:6px; border-top:1px solid #eee;
  }
  .controls.show{ display:flex; }
  .control-group{
    display:flex; align-items:center; gap:4px;
    flex:1; min-width:140px;
  }
  .control-group label{
    font-size:11px; white-space:nowrap;
  }
  select,button,input[type="range"]{
    font:inherit; padding:4px 8px; 
    border:1px solid #ccc; border-radius:4px; 
    background:#fff; font-size:11px;
    flex:1;
  }
  input[type="range"]{ 
    min-width:60px;
    -webkit-appearance:none; appearance:none;
    height:6px; background:#ddd; outline:none;
    border-radius:3px;
  }
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none; appearance:none;
    width:16px; height:16px; background:#0095f6;
    border-radius:50%; cursor:pointer;
  }
  input[type="range"]::-moz-range-thumb{
    width:16px; height:16px; background:#0095f6;
    border-radius:50%; cursor:pointer; border:0;
  }
  button{ 
    padding:6px 12px; background:#0095f6; 
    color:#fff; border:none; cursor:pointer;
    font-weight:500;
  }
  button:active{ background:#0077cc; }
  .value-display{
    font-size:10px; color:#666; 
    min-width:30px; text-align:right;
  }
  .hint{ 
    font-size:10px; color:#888; 
    margin-top:4px; display:block;
  }

  .grid{
    display:grid;
    grid-template-columns:repeat(var(--cols), calc(var(--frame-w)*var(--scale)));
    gap:var(--gap);
    justify-content:center;
    padding:15px;
    width:fit-content;
    max-width:calc(100% - 30px);
    margin:0 auto;
  }
  .card{
    width:calc(var(--frame-w)*var(--scale));
    border:1px solid #ddd; border-radius:4px; 
    background:#fff; overflow:hidden;
    box-shadow:0 1px 3px rgba(0,0,0,0.1);
  }
  .meta{
    font-size:10px; padding:3px 5px; 
    border-bottom:1px solid #eee;
    display:flex; justify-content:space-between; 
    align-items:center; line-height:1.3;
    background:#fafafa;
  }
  .meta span{ 
    overflow:hidden; text-overflow:ellipsis; 
    white-space:nowrap; flex:1;
  }
  .meta a{ 
    text-decoration:none; color:#0095f6;
    border:1px solid #ddd; border-radius:3px; 
    padding:2px 6px; font-size:9px;
    margin-left:4px; flex-shrink:0;
  }
  .meta a:active{ background:#f0f0f0; }
  .scale-wrap{
    width:calc(var(--frame-w)*var(--scale));
    height:calc(var(--frame-h)*var(--scale));
    overflow:hidden; position:relative;
    background:#fff;
  }
  .scale-inner{
    width:var(--frame-w); height:var(--frame-h);
    transform:scale(var(--scale)); transform-origin:top left;
  }
  iframe{ 
    width:100%; height:100%; border:0; display:block;
    background:#fff;
  }

  /* タブレット・PC用 */
  @media (min-width: 769px){
    .menu-toggle{ display:none; }
    .controls{ display:flex !important; }
    .header-main{ margin-bottom:0; }
    header{ 
      display:flex; justify-content:space-between; 
      align-items:center; padding:8px 20px;
    }
  }

  /* シンプル＆確実なレスポンシブ設定 */
  
  /* PC大 (1401px以上) */
  @media (min-width: 1401px){ 
    :root{ --cols:8; --frame-w:300px; --scale:0.50; --gap:8px; }
  }
  
  /* PC中・ノートPC (1101-1400px) */
  @media (min-width: 1101px) and (max-width: 1400px){ 
    :root{ --cols:5; --frame-w:360px; --scale:0.68; --gap:8px; }
  }
  
  /* タブレット横・PC小 (901-1100px) */
  @media (min-width: 901px) and (max-width: 1100px){ 
    :root{ --cols:4; --frame-w:360px; --scale:0.68; --gap:8px; }
  }
  
  /* タブレット縦 (651-900px) */
  @media (min-width: 651px) and (max-width: 900px) { 
    :root{ --cols:3; --frame-w:360px; --scale:0.68; --gap:8px; }
  }
  
  /* スマホ横・縦大 (451-650px) */
  @media (min-width: 451px) and (max-width: 650px) { 
    :root{ --cols:2; --frame-w:360px; --scale:0.68; --gap:8px; }
  }
  
  /* スマホ縦 (450px以下) - 完全最適化 */
  @media (max-width: 450px) { 
    :root{ --cols:1; --gap:12px; }
    body{ overflow-x:hidden; }
    .grid{ 
      padding:12px !important;
      display:flex !important;
      flex-direction:column;
      align-items:stretch;
      width:100%;
      max-width:100%;
    }
    .card{ 
      box-shadow:0 2px 8px rgba(0,0,0,0.12);
      width:100% !important;
      max-width:100%;
      border-radius:8px;
    }
    .scale-wrap{
      width:100% !important;
      height:0 !important;
      padding-bottom:138.89% !important;
      position:relative !important;
    }
    .scale-inner{
      position:absolute !important;
      top:0 !important;
      left:0 !important;
      width:100% !important;
      height:100% !important;
      transform:none !important;
    }
    iframe{
      width:100% !important;
      height:100% !important;
      position:absolute;
      top:0;
      left:0;
    }
    .meta{
      font-size:11px;
      padding:5px 8px;
    }
    .hint{ display:inline; }
  }

  /* スマホ横向き - シンプル対応 */
  @media (max-width: 900px) and (orientation: landscape){
    :root{ --cols:3; --frame-w:360px; --scale:0.58; --gap:6px; }
  }
</style>
</head>
<body>

<header>
  <div class="header-main">
    <span class="title">📱 Instagram モニター ×18</span>
    <button class="menu-toggle" onclick="toggleMenu()">⚙️ 設定</button>
  </div>
  <div class="controls" id="controls">
    <div class="control-group">
      <label>列</label>
      <select id="densitySelect">
        <option value="4">4列</option>
        <option value="5">5列</option>
        <option value="8" selected>8列</option>
      </select>
    </div>
    <div class="control-group">
      <label>高さ</label>
      <input id="heightRange" type="range" min="300" max="500" step="10" value="500" />
      <span id="heightDisplay" class="value-display">500</span>
    </div>
    <div class="control-group">
      <label>更新</label>
      <select id="intervalSelect">
        <option value="0">OFF</option>
        <option value="300000">5分</option>
        <option value="600000" selected>10分</option>
        <option value="900000">15分</option>
      </select>
    </div>
    <button id="refreshBtn">🔄 更新</button>
    <span class="hint">💡 1列表示の時は上下スワイプで切替可能</span>
  </div>
</header>

<main class="grid" id="grid"></main>

<script>
const usernames = [
  "okamura_koumuten","karada_4590","mayasound8","yamatosangyo_kyoto",
  "tamayobi_official","allespetaplus","nagasawa0208","trys_fudosan_hisatoshimada",
  "villa_amatsuboshi","mist_watasi","pety.official.store","fullbrain2025",
  "plus.one_osaka","mikataokinawa","GELpress.japan","outdoorchair_lab",
  "marklis.web.marketing","azzurro_tokyo"
];

const grid = document.getElementById("grid");
const densitySelect = document.getElementById("densitySelect");
const heightRange = document.getElementById("heightRange");
const heightDisplay = document.getElementById("heightDisplay");
const intervalSelect = document.getElementById("intervalSelect");
const refreshBtn = document.getElementById("refreshBtn");
const controls = document.getElementById("controls");

function toggleMenu(){
  controls.classList.toggle("show");
}

function createCard(name){
  const card = document.createElement("div");
  card.className = "card";

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.innerHTML = `<span>@${name}</span>
    <a href="https://www.instagram.com/${name}/" target="_blank" rel="noopener noreferrer">開く</a>`;

  const wrap = document.createElement("div");
  wrap.className = "scale-wrap";
  const inner = document.createElement("div");
  inner.className = "scale-inner";
  const iframe = document.createElement("iframe");
  iframe.loading = "lazy";
  iframe.sandbox = "allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox";
  iframe.dataset.src = `https://www.instagram.com/${name}/embed`;
  iframe.title = `Instagram profile: ${name}`;

  inner.appendChild(iframe);
  wrap.appendChild(inner);
  card.append(meta, wrap);
  return card;
}

function render(){
  grid.innerHTML = "";
  usernames.forEach(u => grid.appendChild(createCard(u)));
  
  // Intersection Observer で遅延読み込み
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if(entry.isIntersecting){
        const iframe = entry.target;
        if(iframe.dataset.src && !iframe.src){
          iframe.src = iframe.dataset.src;
          observer.unobserve(iframe);
        }
      }
    });
  }, {
    rootMargin: '100px'
  });

  document.querySelectorAll('iframe').forEach(iframe => {
    observer.observe(iframe);
  });
}

function applyDensity(cols){
  const r = document.documentElement.style;
  const settings = {
    4: { w: 360, scale: 0.68 },
    5: { w: 360, scale: 0.68 },
    8: { w: 300, scale: 0.50 }
  };
  
  const s = settings[cols] || settings[8];
  r.setProperty("--cols", cols);
  r.setProperty("--frame-w", s.w + "px");
  r.setProperty("--scale", s.scale);
}

function applyHeight(px){
  document.documentElement.style.setProperty("--frame-h", px + "px");
  heightDisplay.textContent = px;
  try {
    localStorage.setItem("ig_dashboard_frame_h", String(px));
  } catch(e) {
    console.warn('localStorage not available:', e);
  }
}

let timer = null;
function setAutoRefresh(ms){
  if(timer) clearInterval(timer);
  if(ms && Number(ms)>0){
    timer = setInterval(()=>refreshIframes(), Number(ms));
  }
}

function refreshIframes(){
  document.querySelectorAll("iframe").forEach(f=>{
    if(f.src){
      const originalSrc = f.dataset.src || f.src.split('?')[0];
      f.src = `${originalSrc}?_t=${Date.now()}`;
    }
  });
}

// スマホでスワイプナビゲーション（1列表示時）
let touchStartX = 0;
let touchEndX = 0;
let touchStartY = 0;
let touchEndY = 0;

document.addEventListener('touchstart', e => {
  touchStartX = e.changedTouches[0].screenX;
  touchStartY = e.changedTouches[0].screenY;
}, { passive: true });

document.addEventListener('touchend', e => {
  touchEndX = e.changedTouches[0].screenX;
  touchEndY = e.changedTouches[0].screenY;
  handleSwipe();
}, { passive: true });

function handleSwipe(){
  const cols = Number(getComputedStyle(document.documentElement).getPropertyValue('--cols'));
  if(cols !== 1) return;
  
  const diffX = touchStartX - touchEndX;
  const diffY = touchStartY - touchEndY;
  
  // 横スワイプより縦スワイプが大きい場合は通常のスクロール
  if(Math.abs(diffY) > Math.abs(diffX)) return;
  
  if(Math.abs(diffX) > 50){
    if(diffX > 0){
      window.scrollBy({top: window.innerHeight * 0.8, behavior: 'smooth'});
    } else {
      window.scrollBy({top: -window.innerHeight * 0.8, behavior: 'smooth'});
    }
  }
}

// 初期化
render();
applyDensity(Number(densitySelect.value));

let savedH = 500;
try {
  savedH = Number(localStorage.getItem("ig_dashboard_frame_h") || "500");
} catch(e) {
  console.warn('localStorage not available:', e);
}

if(savedH >= 300 && savedH <= 500){ 
  heightRange.value = savedH; 
  applyHeight(savedH); 
} else { 
  applyHeight(500); 
}

setAutoRefresh(intervalSelect.value);

// イベントリスナー
densitySelect.onchange = e => {
  applyDensity(Number(e.target.value));
};

heightRange.oninput = e => applyHeight(Number(e.target.value));

intervalSelect.onchange = e => setAutoRefresh(e.target.value);

refreshBtn.onclick = () => refreshIframes();

// ウィンドウリサイズ時に再調整（デバウンス）
let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    applyDensity(Number(densitySelect.value));
  }, 250);
});

// ページ読み込み完了後の最終調整
window.addEventListener('load', () => {
  applyDensity(Number(densitySelect.value));
});
</script>

</body>
</html>
